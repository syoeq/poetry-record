<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è¯—é…’æ­Œè¡Œ</title>
  <style>
    /* ========== å…¨å±€åŸºç¡€æ ·å¼ ========== */
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f9fa;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(90deg, #ff7eb3, #ff758c);
      color: #fff;
      text-align: center;
      padding: 10px 0;
      font-size: 1.5em;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    nav {
      display: flex;
      justify-content: space-around;
      background: #ff94c2;
      padding: 10px 0;
    }
    nav button {
      padding: 10px 15px;
      border: none;
      border-radius: 6px; 
      background: #fff;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s ease;
      margin: 3px;
    }
    nav button:hover {
      background: #ffe3ee;
    }

    /* è®©ä¸»å†…å®¹åŒºç•™å‡ºåº•éƒ¨ç©ºé—´ï¼Œé¿å…è¢«å›ºå®šfooteré®æŒ¡ */
    main {
      padding: 20px;
      padding-bottom: 100px; /* æ ¹æ®footeré«˜åº¦åšé€‚å½“è°ƒæ•´ */
    }

    .section {
      display: none;
    }
    .section.active {
      display: block;
    }

    /* å¡ç‰‡å¸ƒå±€ */
    .movie-list-grid {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }

    .movie-card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      text-align: center;
      position: relative;
    }
    .movie-card button {
      margin: 3px;
    }

    /* å¦‚æœæœ‰è§‚å½±æ„Ÿæƒ³åˆ™æ˜¾ç¤ºåœ¨è¿™é‡Œ */
    .review-text {
      color: #555;
      font-style: italic;
      margin-top: 6px;
      white-space: pre-line; /* ä¿ç•™æ¢è¡Œ */
    }

    /* æœç´¢æ—¶çš„é«˜äº®è¾¹æ¡† */
    .highlight {
      border: 2px solid red;
    }

    /* åœ¨å°å±å¹•ä¸‹ï¼Œè®© nav æŒ‰é’® & å¡ç‰‡ä¸€åˆ—æ˜¾ç¤º */
    @media (max-width: 600px) {
      nav {
        flex-direction: column;
        align-items: center;
      }
      nav button {
        width: 80%;
        margin: 5px 0;
      }
      .movie-list-grid {
        grid-template-columns: 1fr;
      }
    }

    /* ========== å›ºå®šåº•éƒ¨ footer ========== */
    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #ff94c2;
      text-align: center;
      padding: 10px 0;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2);
      z-index: 9999; 
    }
    footer button {
      margin: 3px;
      padding: 6px 12px;
      border: none;
      border-radius: 10px; 
      background: #fff;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s ease;
    }
    footer button:hover {
      background: #ffe3ee;
    }

    /* ç»Ÿè®¡å®¹å™¨ */
    #stats-container {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
    }
    #stats-container > div {
      flex: 1;
      text-align: center;
      font-size: 1.1em;
      font-weight: bold;
      margin: 0 5px;
    }

    /* ç§¯åˆ†æ˜¾ç¤º */
    .points-display {
      color: #ff4500; 
      font-weight: bold;
      text-align: center;
      margin: 10px 0;
      font-size: 1.2em;
    }

    /* æ¨¡æ€æ¡†åŸºç¡€ */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000; /* æé«˜z-indexï¼Œä¿è¯è¦†ç›–footer */
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto; 
      background-color: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto; 
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 10px;
      max-height: 80%; 
      overflow-y: auto; 
    }

    /* æŠ˜å /å±•å¼€ (å·²è§‚çœ‹) */
    .collapsible-header {
      cursor: pointer;
      font-weight: bold;
      background: #ffe3ee;
      padding: 8px;
      border-radius: 5px;
      margin: 5px 0;
    }
    .collapsible-content {
      display: none;
      margin: 5px 0;
    }
    .collapsible-content.show {
      display: block;
    }

    /* è¿‡æœŸç›®æ ‡çš„æ ·å¼ */
    .expired {
      background-color: #ffe0e0; 
      border-color: red;
    }
    .expired-text {
      color: red;
    }

    /* æ’åº/ç­›é€‰æ¨¡æ€æ¡† */
    #sort-filter-modal {
      display: none;
      position: fixed;
      z-index: 12000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,.5);
    }
    #sort-filter-modal .modal-content {
      margin: 10% auto;
      max-width: 400px;
      max-height: 80%;
      overflow-y: auto;
    }

    /* æ–°å¢æ„Ÿæƒ³æ¨¡æ€æ¡†æ ·å¼ */
    .review-modal textarea {
      width: 100%;
      height: 150px;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      resize: vertical;
    }

    /* ä¼˜åŒ–åçš„æ„Ÿæƒ³å±•ç¤ºæ ·å¼ */
    .review-text {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      border-left: 3px solid #ff94c2;
    }
  </style>
</head>
<body>
  <header>ğŸ¬ è¯—é…’æ­Œè¡Œ âœ¨</header>

  <nav>
    <button onclick="showSection('goal-section')">æœ”ç ‚åŒ£</button>
    <button onclick="showSection('list-section')">æµ®å…‰å½•</button>
  </nav>

  <main>
    <!-- =========== æœ”ç ‚åŒ£åŒº =========== -->
     
    <section id="goal-section" class="section active">
      <h2>ğŸ’Ÿ æœ”ç ‚åŒ£</h2>

      <div class="points-display">
        å½“å‰ç§¯åˆ†ï¼š<span id="points-value">0</span>
      </div>

      <label for="weekly-goal">è®¾ç½®æœ¬æœˆç›®æ ‡ç”µå½±æ•°ï¼š</label>
      <input type="number" id="weekly-goal" value="3" style="width:60px;"/>

      <label for="deadline">ç›®æ ‡æˆªæ­¢æ—¥æœŸï¼š</label>
      <input type="date" id="deadline" />

      <div style="margin:10px 0;">
        <button onclick="manualSelectGoal()">æ‰‹åŠ¨é€‰æ‹©ç›®æ ‡</button>
        <button onclick="randomGenerateGoal()">éšæœºç”Ÿæˆç›®æ ‡</button>
      </div>

      <h3>ğŸŒŠåŠè½®æ˜Ÿæ¸¡ï¼š</h3>
      <div id="goal-list"cha class="movie-list-grid"></div>

      <h3>ğŸŒŒé™å½±æ²‰ç’§ï¼š</h3>
      <div id="completed-collapsible"></div>
    </section>

    <!-- æ‰‹åŠ¨é€‰æ‹©ç›®æ ‡ æ¨¡æ€æ¡† -->
    <div id="manual-select-modal" class="modal">
      <div class="modal-content">
        <h3>è¯·é€‰æ‹©æœ¬æœˆç›®æ ‡ç”µå½±ï¼š</h3>
        <div id="manual-select-list"></div>
        <button onclick="confirmManualSelection()">ç¡®è®¤é€‰æ‹©</button>
        <button onclick="closeModal()">å–æ¶ˆ</button>
      </div>
    </div>

    <!-- =========== æµ®å…‰å½•åŒº =========== -->
    <section id="list-section" class="section">
      <div id="stats-container">
        <div style="color: #ff7eb3;">
          ğŸ¬ æ€»ç”µå½±æ•°ï¼š
          <span id="total-movies">0</span>
        </div>
        <div style="color: #ffb347;">
          ğŸ“Œ æœªè§‚çœ‹ï¼š
          <span id="unwatched-movies">0</span>
        </div>
        <div style="color: #66cdaa;">
          âœ… å·²è§‚çœ‹ï¼š
          <span id="watched-movies">0</span>
        </div>
      </div>

      <div class="points-display">
        å½“å‰ç§¯åˆ†ï¼š<span id="points-value-2">0</span>
      </div>

      <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ æ§ä»¶ -->
      <input 
        type="file" 
        id="fileInput" 
        style="display: none;" 
        accept=".json"
        onchange="handleFileUpload(event)"
      />

      <h3>æœªè§‚çœ‹åˆ—è¡¨</h3>
      <button onclick="markAllAsWatched()">ä¸€é”®å…¨éƒ¨è§‚çœ‹</button>
      <div id="movie-list" class="movie-list-grid"></div>
    </section>
  </main>

  <!-- æ’åº/ç­›é€‰ æ¨¡æ€æ¡† -->
  <div id="sort-filter-modal" class="modal">
    <div class="modal-content">
      <h3>æ’åº & ç­›é€‰</h3>
      <label>æ’åºå­—æ®µï¼š</label>
      <select id="sort-field">
        <option value="">(ä¸æ’åº)</option>
        <option value="year">å¹´ä»½</option>
        <option value="rating">è¯„åˆ†</option>
        <option value="country">å›½å®¶</option>
        <option value="type">ç±»å‹</option>
        <option value="title">æ ‡é¢˜</option>
        <option value="completedDate">åˆè§æ—¥æœŸ</option>
      </select>
      <label>é¡ºåºï¼š</label>
      <select id="sort-order">
        <option value="asc">å‡åº</option>
        <option value="desc">é™åº</option>
      </select>
      <label>ç­›é€‰å›½å®¶ï¼š</label>
      <select id="filter-country">
        <option value="">(ä¸é™)</option>
      </select>
      <label>ç­›é€‰è¯„åˆ†ï¼š</label>
      <input type="number" id="filter-rating" placeholder="æœ€å°è¯„åˆ†" style="width:60px;" />
      
      <button onclick="applySortFilter()">åº”ç”¨</button>
      <button onclick="closeSortFilterModal()">å…³é—­</button>
    </div>
  </div>

  <footer>
    <button onclick="openFile()">ğŸ“‚ æ‰¹é‡å¯¼å…¥</button>
    <button onclick="searchMovies()">ğŸ” æœç´¢ç”µå½±</button>
    <button onclick="addMovie()">â• æ‰‹åŠ¨æ·»åŠ </button>
    <button onclick="openSortFilterModal()">ğŸ”½ æ’åº/ç­›é€‰</button>
    <button onclick="removeDuplicates()">ğŸ—‘ å»é‡</button>
  </footer>

  <script>
    /* ==============================
     *  å…¨å±€å˜é‡ & æœ¬åœ°å­˜å‚¨
     * ============================== */
    let movies = [];
    let weeklyGoal = []; 
    let points = 0;

    function loadData() {
      const savedMovies = localStorage.getItem("movies");
      const savedWeeklyGoal = localStorage.getItem("weeklyGoal");
      const savedPoints = localStorage.getItem("points");

      if (savedMovies) movies = JSON.parse(savedMovies);
      if (savedWeeklyGoal) weeklyGoal = JSON.parse(savedWeeklyGoal);
      if (savedPoints) points = parseInt(savedPoints, 10);
    }

    function saveData() {
      localStorage.setItem("movies", JSON.stringify(movies));
      localStorage.setItem("weeklyGoal", JSON.stringify(weeklyGoal));
      localStorage.setItem("points", points);
    }

    loadData(); 

    /* ==============================
     *  é¡µé¢åŒºå—åˆ‡æ¢
     * ============================== */
    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
    }

    /* ==============================
     *  ç§¯åˆ†æ˜¾ç¤º
     * ============================== */
    function updatePointsDisplay() {
      const el1 = document.getElementById("points-value");
      const el2 = document.getElementById("points-value-2");
      if (el1) el1.textContent = points;
      if (el2) el2.textContent = points;
    }

    /* ==============================
     *  æ¸²æŸ“â€œæœªè§‚çœ‹â€ç”µå½±æ¸…å•
     * ============================== */
    function renderMovieList() {
      const movieList = document.getElementById("movie-list");
      if (!movieList) return;
      movieList.innerHTML = '';

      movies
        .filter(m => !m.watched)
        .forEach(movie => {
          const div = document.createElement("div");
          div.className = "movie-card";
          div.innerHTML = `
            <h4>${movie.title} (${movie.year})</h4>
            <p>${movie.country} | è¯„åˆ†ï¼š${movie.rating} | ç±»å‹ï¼š${movie.type}</p>
          `;

          // â€œæ ‡è®°å·²çœ‹â€æŒ‰é’®
          const watchBtn = document.createElement("button");
          watchBtn.textContent = "æ ‡è®°å·²çœ‹";
          watchBtn.onclick = () => markAsWatched(movie.title);

          // â€œç¼–è¾‘â€æŒ‰é’®
          const editBtn = document.createElement("button");
          editBtn.textContent = "ç¼–è¾‘";
          editBtn.onclick = () => editMovie(movie.title);

          // â€œåˆ é™¤â€æŒ‰é’®
          const delBtn = document.createElement("button");
          delBtn.textContent = "åˆ é™¤";
          delBtn.onclick = () => deleteMovie(movie.title);

          div.appendChild(watchBtn);
          div.appendChild(editBtn);
          div.appendChild(delBtn);

          movieList.appendChild(div);
        });
    }

      /* ==============================
   *  ä¸€é”®å…¨éƒ¨è§‚çœ‹
   * ============================== */
  function markAllAsWatched() {
    const unwatchedMovies = movies.filter(m => !m.watched);
    if (unwatchedMovies.length === 0) {
      alert("æ‰€æœ‰ç”µå½±éƒ½å·²è§‚çœ‹ï¼");
      return;
    }

    const today = new Date().toISOString().split('T')[0];
    const confirmed = confirm(`ç¡®å®šè¦å°†${unwatchedMovies.length}éƒ¨ç”µå½±æ ‡è®°ä¸ºå·²è§‚çœ‹ï¼Ÿ`);
    
    if (confirmed) {
      unwatchedMovies.forEach(movie => {
        movie.watched = true;
        movie.completedDate = today;
      });

      const addedPoints = unwatchedMovies.length * 10;
      points += addedPoints;

      alert(`å·²å°†${unwatchedMovies.length}éƒ¨ç”µå½±æ ‡è®°ä¸ºå·²è§‚çœ‹ï¼Œç§¯åˆ†+${addedPoints}ï¼Œæ€»ç§¯åˆ†ï¼š${points}`);

      // æ›´æ–°ç•Œé¢
      renderMovieList();
      renderGoalList();
      renderCompletedList();
      updateStats();
      updatePointsDisplay();
      saveData();

      // æ˜¾ç¤ºâ€œå·²è§‚çœ‹â€åŒºåŸŸ
      showSection('goal-section');
      // æ»šåŠ¨åˆ°é¡¶éƒ¨
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

    /* ==============================
     *  æ ‡è®°å·²çœ‹
     * ============================== */
    function markAsWatched(title) {
      const today = new Date().toISOString().split('T')[0];

      movies = movies.map(movie => {
        if (movie.title === title) {
          movie.watched = true;
          movie.completedDate = today;
        }
        return movie;
      });

      points += 10; 
      alert(`å®Œæˆï¼ç§¯åˆ†+10ï¼Œæ€»ç§¯åˆ†ï¼š${points}`);

      renderMovieList();
      renderGoalList();
      renderCompletedList();
      updateStats();
      updatePointsDisplay();
      saveData();
    }

 /* ==============================
   *  ç¼–è¾‘ç”µå½±ä¿¡æ¯
   * ============================== */
    function editMovie(title) {
      const movie = movies.find(m => m.title === title);
      if (!movie) return;

      // åˆ›å»ºä¸€ä¸ªæ¨¡æ€æ¡†æ¥ç¼–è¾‘ç”µå½±ä¿¡æ¯
      const modal = document.createElement("div");
      modal.classList.add("modal");
      modal.innerHTML = `
        <div class="modal-content">
          <h3>ç¼–è¾‘ç”µå½±ä¿¡æ¯</h3>
          <label>ç”µå½±åç§°:</label>
          <input type="text" id="edit-title" value="${movie.title}">
          <label>å¹´ä»½:</label>
          <input type="text" id="edit-year" value="${movie.year}">
          <label>å›½å®¶:</label>
          <input type="text" id="edit-country" value="${movie.country}">
          <label>è¯„åˆ†:</label>
          <input type="text" id="edit-rating" value="${movie.rating}">
          <label>ç±»å‹:</label>
          <input type="text" id="edit-type" value="${movie.type}">
          <label>æˆªæ­¢æ—¥æœŸ:</label>
          <input type="date" id="edit-deadline" value="${movie.deadline || ''}">
          <button onclick="saveEdit('${movie.title}')">ä¿å­˜</button>
          <button onclick="closeModal()">å–æ¶ˆ</button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function saveEdit(originalTitle) {
      const movie = movies.find(m => m.title === originalTitle);
      if (!movie) return;

      // è·å–æ–°çš„ç¼–è¾‘ä¿¡æ¯
      const newTitle = document.getElementById("edit-title").value;
      const newYear = document.getElementById("edit-year").value;
      const newCountry = document.getElementById("edit-country").value;
      const newRating = document.getElementById("edit-rating").value;
      const newType = document.getElementById("edit-type").value;
      const newDeadline = document.getElementById("edit-deadline").value;

      // æ›´æ–°ç”µå½±ä¿¡æ¯
      Object.assign(movie, {
        title: newTitle,
        year: newYear,
        country: newCountry,
        rating: newRating,
        type: newType,
        deadline: newDeadline
      });

      alert(`å·²æ›´æ–°ç”µå½±ä¿¡æ¯ï¼š${newTitle} (${newYear})`);
      closeModal(); 
      renderMovieList();
      renderGoalList();
      renderCompletedList();
      updateStats();
      updatePointsDisplay();
      saveData();
    }

    function closeModal() {
      const modal = document.querySelector(".modal");
      if (modal) {
        modal.remove();
      }
    }

    /* ==============================
     *  åˆ é™¤ç”µå½±
     * ============================== */
    function deleteMovie(title) {
      const confirmDel = confirm(`ç¡®å®šè¦åˆ é™¤ã€Š${title}ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`);
      if (!confirmDel) return;

      movies = movies.filter(m => m.title !== title);
      weeklyGoal = weeklyGoal.filter(m => m.title !== title);

      alert(`ã€Š${title}ã€‹å·²åˆ é™¤ã€‚`);
      renderMovieList();
      renderGoalList();
      renderCompletedList();
      updateStats();
      updatePointsDisplay();
      saveData();
    }

    /* ==============================
     *  åœ¨â€œå·²è§‚çœ‹â€ä¸­è®°å½•æ„Ÿæƒ³
     * ============================== */
    function recordReview(title) {
      const movie = movies.find(m => m.title === title);
      if (!movie) return;

      const newReview = prompt("è¯·è¾“å…¥è§‚å½±æ„Ÿæƒ³ï¼š", movie.review || "");
      if (newReview === null) return; 

      movies = movies.map(m => {
        if (m.title === title) {
          return { ...m, review: newReview };
        }
        return m;
      });

      alert("æ„Ÿæƒ³å·²æ›´æ–°ï¼");
      renderCompletedList();
      saveData();
    }

    /* ==============================
     *  æœ”ç ‚åŒ£: æ‰‹åŠ¨é€‰æ‹©
     * ============================== */
     function manualSelectGoal() {
    const modal = document.getElementById("manual-select-modal");
    const list = document.getElementById("manual-select-list");
    list.innerHTML = '';

    movies
      .filter(movie => !movie.watched)
      .forEach(movie => {
        const div = document.createElement("div");
        div.innerHTML = `
          <input type="checkbox" id="${movie.title}" value="${movie.title}">
          <label for="${movie.title}">${movie.title} (${movie.year})</label>
        `;
        list.appendChild(div);
      });

    modal.style.display = "block";
  }

  function confirmManualSelection() {
    const modal = document.getElementById("manual-select-modal");
    const checkboxes = document.querySelectorAll("#manual-select-list input[type='checkbox']:checked");
    const selectedTitles = Array.from(checkboxes).map(checkbox => checkbox.value);

    weeklyGoal = [];

    const deadlineInput = document.getElementById("deadline").value;
    const fallback = new Date();
    fallback.setDate(fallback.getDate() + 7);
    const finalDeadline = deadlineInput ? new Date(deadlineInput) : fallback;

    selectedTitles.forEach(title => {
      const movie = movies.find(m => m.title === title);
      if (movie) {
        weeklyGoal.push({
          ...movie,
          deadline: finalDeadline.toISOString().split('T')[0]
        });
      }
    });

    modal.style.display = "none";
    renderGoalList();
    saveData();
  }

    /* ==============================
     *  éšæœºç”Ÿæˆç›®æ ‡
     * ============================== */
    function randomGenerateGoal() {
      const goalNumber = parseInt(document.getElementById('weekly-goal').value);
      if (!goalNumber || goalNumber <= 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ç›®æ ‡æ•°é‡ï¼");
        return;
      }

      const deadlineInput = document.getElementById("deadline").value;
      const fallback = new Date();
      fallback.setDate(fallback.getDate() + 7);
      const finalDeadline = deadlineInput ? new Date(deadlineInput) : fallback;

      const candidates = movies.filter(movie => !movie.watched);
      candidates.sort(() => Math.random() - 0.5);
      const chosen = candidates.slice(0, goalNumber);

      weeklyGoal = chosen.map(m => ({
        ...m,
        deadline: finalDeadline.toISOString().split('T')[0]
      }));

      renderGoalList();
      saveData();
    }

    /* ==============================
     *  æ¸²æŸ“åŠè½®æ˜Ÿæ¸¡ (å«é€¾æœŸæç¤º)
     * ============================== */
     function renderGoalList() {
    const goalList = document.getElementById("goal-list");
    if (!goalList) return;
    goalList.innerHTML = '';

    const now = new Date();

    weeklyGoal.forEach(movie => {
      const div = document.createElement("div");
      div.className = 'movie-card';

      let info = '';
      if (movie.deadline) {
        const dl = new Date(movie.deadline);
        const diffTime = dl - now;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        if (diffDays > 0) {
          info = `è¿˜å‰©${diffDays}å¤©åˆ°æœŸ`;
        } else {
          info = `å·²é€¾æœŸ${Math.abs(diffDays)}å¤©`;
          div.classList.add("expired");
        }
      } else {
        info = 'æ— æˆªæ­¢æ—¥æœŸ';
      }

      div.innerHTML = `
        <h3>${movie.title} (${movie.year})</h3>
        <p>æˆªæ­¢ï¼š<span>${movie.deadline || 'æ— '}</span> / ${info}</p>
      `;

      const btnComplete = document.createElement("button");
      btnComplete.textContent = "å®Œæˆ";
      btnComplete.onclick = () => completeGoal(movie.title);

      const btnSkip = document.createElement("button");
      btnSkip.textContent = "è·³è¿‡(-5åˆ†)";
      btnSkip.onclick = () => skipGoal(movie.title);

      div.appendChild(btnComplete);
      div.appendChild(btnSkip);
      goalList.appendChild(div);
    });
  }

    /* ==============================
     *  å®Œæˆ/è·³è¿‡ ç›®æ ‡ (é€¾æœŸä¸åŠ åˆ†)
     * ============================== */
     function completeGoal(title) {
        const today = new Date().toISOString().split('T')[0]; 
        const goalItem = weeklyGoal.find(m => m.title === title);
        const expiredFlag = goalItem && goalItem.deadline && today > goalItem.deadline;

        movies = movies.map(movie => {
          if (movie.title === title) {
            movie.watched = true;
            movie.completedDate = today;
          }
          return movie;
        });
        weeklyGoal = weeklyGoal.filter(m => m.title !== title);

        if (!expiredFlag) {
          points += 10;
          alert(`å®Œæˆï¼ç§¯åˆ†+10ï¼Œæ€»ç§¯åˆ†ï¼š${points}`);
        } else {
          alert("å®Œæˆï¼Œä½†å·²è¶…è¿‡æˆªæ­¢æ—¥æœŸï¼Œæœªè·å¾—ç§¯åˆ†ã€‚");
        }

        renderMovieList();
        renderGoalList();
        renderCompletedList();
        updateStats();
        updatePointsDisplay();
        saveData();
      }


    function skipGoal(title) {
      alert(`è·³è¿‡ã€Š${title}ã€‹ï¼Œæ‰£é™¤5åˆ†ã€‚`);
      points -= 5;
      weeklyGoal = weeklyGoal.filter(m => m.title !== title);

      renderGoalList();
      updateStats();
      updatePointsDisplay();
      saveData();
    }

/* ============================== 
 *  æ¸²æŸ“å·²è§‚çœ‹åˆ—è¡¨ (æŒ‰æ—¥æœŸæŠ˜å )
 *  - è¿™é‡Œå¯ç¼–è¾‘ã€åˆ é™¤ã€è®°å½•è§‚å½±æ„Ÿæƒ³
 * ============================== */
/* ============================== 
 *  æ¸²æŸ“å·²è§‚çœ‹åˆ—è¡¨ (æŒ‰ç±»å‹æŠ˜å )
 *  - è¿™é‡Œå¯ç¼–è¾‘ã€åˆ é™¤ã€è®°å½•è§‚å½±æ„Ÿæƒ³
 * ============================== */
 function renderCompletedList() {
  const container = document.getElementById("completed-collapsible");
  if (!container) return;
  container.innerHTML = '';

  const watchedMovies = movies.filter(m => m.watched);
  // æŒ‰ç±»å‹åˆ†ç±»
  const types = {};
  watchedMovies.forEach(m => {
    const t = m.type || 'æœªçŸ¥ç±»å‹';
    if (!types[t]) types[t] = [];
    types[t].push(m);
  });

  // æŒ‰ç±»å‹é™åº
  Object.keys(types)
    .sort((a, b) => b.localeCompare(a))
    .forEach(typeStr => {
      const header = document.createElement("div");
      header.className = "collapsible-header";
      header.textContent = `${typeStr} (${types[typeStr].length}éƒ¨)`;
      header.onclick = () => {
        content.classList.toggle("show");
      };

      const content = document.createElement("div");
      content.className = "collapsible-content";
      const grid = document.createElement("div");
      grid.className = "movie-list-grid";

      types[typeStr].forEach(movie => {
        const div = document.createElement("div");
        div.className = "movie-card";
        div.dataset.movieId = movie.title; 

        // æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
        let html = `
          <h4>${movie.title} (${movie.year})</h4>
          <p>${movie.country} | è¯„åˆ†ï¼š${movie.rating} | ç±»å‹ï¼š${movie.type}</p>
          <p>åˆè§ï¼š${movie.completedDate ? movie.completedDate : 'æœªè®¾å®š'}</p>
        `;

        // å¦‚æœæœ‰è§‚å½±æ„Ÿæƒ³
        if (movie.review) {
          html += `<div class="review-text">è§‚å½±æ„Ÿæƒ³ï¼š${movie.review}</div>`;
        }
        div.innerHTML = html;

        // â€œç¼–è¾‘â€æŒ‰é’®
        const editBtn = document.createElement("button");
        editBtn.textContent = "ç¼–è¾‘";
        editBtn.onclick = () => toggleEdit(div);
        div.appendChild(editBtn);

        // "åˆ é™¤"æŒ‰é’®
        const delBtn = document.createElement("button");
        delBtn.textContent = "åˆ é™¤";
        delBtn.onclick = () => deleteMovie(movie, div);
        div.appendChild(delBtn);

        // â€œè®°å½•æ„Ÿæƒ³â€æŒ‰é’®
        const reviewBtn = document.createElement("button");
        reviewBtn.textContent = "è®°å½•æ„Ÿæƒ³";
        reviewBtn.onclick = () => recordReview(movie, div);
        div.appendChild(reviewBtn);

        grid.appendChild(div);
      });

      content.appendChild(grid);
      container.appendChild(header);
      container.appendChild(content);
    });
}

// åˆ é™¤ç”µå½±
function deleteMovie(movie, movieDiv) {
  if (confirm(`ç¡®å®šè¦åˆ é™¤ã€Š${movie.title}ã€‹å—ï¼Ÿ`)) {
    // åˆ é™¤ç”µå½±
    movies = movies.filter(m => m.title !== movie.title);
    renderCompletedList(); // åˆ é™¤åé‡æ–°æ¸²æŸ“åˆ—è¡¨
    saveData(); // ä¿å­˜æ›´æ–°åçš„æ•°æ®
    alert("ç”µå½±å·²åˆ é™¤ï¼");
  }
}

// è®°å½•æˆ–ç¼–è¾‘ç”µå½±æ„Ÿæƒ³
function recordReview(movie, movieDiv) {
  const reviewInput = document.createElement("textarea");
  reviewInput.value = movie.review || "";
  reviewInput.style.display = "block";
  reviewInput.style.width = "100%";
  reviewInput.style.height = "100px";

  const saveReviewBtn = document.createElement("button");
  saveReviewBtn.textContent = "ä¿å­˜æ„Ÿæƒ³";
  saveReviewBtn.onclick = () => saveReview(movie, reviewInput.value, movieDiv);

  const cancelBtn = document.createElement("button");
  cancelBtn.textContent = "å–æ¶ˆ";
  cancelBtn.onclick = () => cancelReview(movieDiv);

  movieDiv.appendChild(reviewInput);
  movieDiv.appendChild(saveReviewBtn);
  movieDiv.appendChild(cancelBtn);
}

// ä¿å­˜æ„Ÿæƒ³
function saveReview(movie, newReview, movieDiv) {
  movie.review = newReview;
  alert("æ„Ÿæƒ³å·²ä¿å­˜ï¼");
  renderCompletedList(); // ä¿å­˜æ„Ÿæƒ³åé‡æ–°æ¸²æŸ“åˆ—è¡¨
  saveData(); // ä¿å­˜æ•°æ®
}

// å–æ¶ˆç¼–è¾‘æ„Ÿæƒ³
function cancelReview(movieDiv) {
  const reviewInputs = movieDiv.querySelectorAll("textarea, button");
  reviewInputs.forEach(input => input.remove());
}



    /* ==============================
     *  ç¼–è¾‘å·²è§‚çœ‹ç”µå½±ä¿¡æ¯
     * ============================== */
     function toggleEdit(movieDiv) {
        const title = movieDiv.querySelector("h4").textContent.split(' ')[0];
        const year = movieDiv.querySelector("h4").textContent.split(' ')[1].replace('(', '').replace(')', '');
        const country = movieDiv.querySelector("p").textContent.split(' ')[0];
        const rating = movieDiv.querySelector("p").textContent.split('è¯„åˆ†ï¼š')[1].split(' ')[0];
        const type = movieDiv.querySelector("p").textContent.split('ç±»å‹ï¼š')[1];
        const completedDate = movieDiv.querySelector("p").textContent.split('åˆè§ï¼š')[1];

        const inputs = [
          { value: title },
          { value: year },
          { value: country },
          { value: rating },
          { value: type },
          { value: completedDate || '' }
        ];

        const saveBtn = document.createElement("button");
        saveBtn.textContent = "ä¿å­˜";
        saveBtn.onclick = () => saveEditedMovie(movieDiv);  // ç»‘å®šäº‹ä»¶

        saveBtn.style.display = "none";

        if (!movieDiv.dataset.editMode) {
          movieDiv.dataset.editMode = true;

          inputs.forEach((input, index) => {
            const inputElem = document.createElement("input");
            inputElem.type = "text";
            if (index === 5) { // å®Œæˆæ—¥æœŸ
              inputElem.type = "month";
              inputElem.value = input.value ? input.value.substr(0, 7) : ''; // æ ¼å¼ä¸º yyyy-mm
            } else {
              inputElem.value = input.value;
            }
            inputElem.style.display = "inline";
            inputElem.style.margin = "3px";
            movieDiv.appendChild(inputElem);
          });

          movieDiv.querySelector("h4").style.display = "none";
          movieDiv.querySelector("p").style.display = "none";
          saveBtn.style.display = "inline";
          movieDiv.appendChild(saveBtn); // åŠ¨æ€æ’å…¥æŒ‰é’®
        } else {
          movieDiv.dataset.editMode = false;

          movieDiv.querySelectorAll("input").forEach(input => input.remove());
          saveBtn.remove();  // ç§»é™¤æŒ‰é’®

          movieDiv.querySelector("h4").style.display = "block";
          movieDiv.querySelector("p").style.display = "block";
        }
      }




      function saveEditedMovie(movieDiv) {
        // è·å–æ‰€æœ‰è¾“å…¥æ¡†ï¼ˆåŒ…æ‹¬æœˆä»½é€‰æ‹©å™¨ï¼‰
        const inputs = movieDiv.querySelectorAll("input[type='text'], input[type='month']"); // ç¡®ä¿åŒ…æ‹¬æ—¥æœŸé€‰æ‹©å™¨
        const title = inputs[0].value;
        const year = inputs[1].value;
        const country = inputs[2].value;
        const rating = inputs[3].value;
        const type = inputs[4].value;
        const completedDate = inputs[5].value; // è·å–æœˆä»½é€‰æ‹©å™¨çš„å€¼ï¼ˆæ ¼å¼ï¼šyyyy-mmï¼‰

        // æ‰¾åˆ°å¯¹åº”çš„ç”µå½±å¯¹è±¡
        const movie = movies.find(m => m.title === movieDiv.dataset.movieId);
        if (movie) {
          movie.title = title;
          movie.year = year;
          movie.country = country;
          movie.rating = rating;
          movie.type = type;
          movie.completedDate = completedDate; // æ›´æ–°â€œå®Œæˆæ—¥æœŸâ€
        }

        // æç¤ºå¹¶é‡æ–°æ¸²æŸ“åˆ—è¡¨
        alert("ç”µå½±ä¿¡æ¯å·²æ›´æ–°ï¼");
        renderCompletedList();
        saveData(); // ç¡®ä¿æ•°æ®è¢«ä¿å­˜
      }



    /* ==============================
     *  æ‰¹é‡å¯¼å…¥ & å»é‡
     * ============================== */
    function openFile() {
      document.getElementById('fileInput').click();
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const importedMovies = JSON.parse(e.target.result);
          if (Array.isArray(importedMovies)) {
            movies = movies.concat(
              importedMovies.map(movie => ({
                title: movie.title || "æœªå‘½åç”µå½±",
                year: movie.year || "æœªçŸ¥å¹´ä»½",
                country: movie.country || "æœªçŸ¥å›½å®¶",
                rating: movie.rating || "æ— è¯„åˆ†",
                type: movie.type || "æœªçŸ¥ç±»å‹",
                watched: movie.watched || false,
                review: movie.review || ""    
              }))
            );
            alert("æµ®å…‰å½•å¯¼å…¥æˆåŠŸï¼");
            removeDuplicates(false);
            renderMovieList();
            renderGoalList();
            renderCompletedList();
            updateStats();
            updatePointsDisplay();
            saveData();
          } else {
            throw new Error("JSON æ ¼å¼é”™è¯¯");
          }
        } catch (error) {
          alert("å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ï¼");
        }
      };
      reader.readAsText(file);
    }

    /* 
      å»é‡åŠŸèƒ½ (title + yearå”¯ä¸€)
      è‹¥ showAlert = false ä¸å¼¹å‡ºæç¤º
      é»˜è®¤ä¿ç•™â€œç¬¬ä¸€æ¬¡å‡ºç°â€çš„æ¡ç›®
    */
    function removeDuplicates(showAlert = true) {
      const uniqueMap = new Map();
      const newArr = [];
      for (let m of movies) {
        const key = m.title + '##' + m.year;
        if (!uniqueMap.has(key)) {
          uniqueMap.set(key, true);
          newArr.push(m);
        }
      }

      const removedCount = movies.length - newArr.length;
      movies = newArr;
      weeklyGoal = weeklyGoal.filter(m => {
        const key = m.title + '##' + m.year;
        return uniqueMap.has(key);
      });

      if (showAlert) {
        if (removedCount > 0) {
          alert(`å·²æ¸…ç† ${removedCount} æ¡é‡å¤ç”µå½±ã€‚`);
        } else {
          alert("æœªå‘ç°é‡å¤ç”µå½±ã€‚");
        }
      }

      renderMovieList();
      renderGoalList();
      renderCompletedList();
      updateStats();
      updatePointsDisplay();
      saveData();
    }

    /* ==============================
     *  ç»Ÿè®¡æ•°æ®
     * ============================== */
    function updateStats() {
      const totalMovies = movies.length;
      const watchedMovies = movies.filter(movie => movie.watched).length;
      const unwatchedMovies = totalMovies - watchedMovies;

      const tm = document.getElementById('total-movies');
      const wm = document.getElementById('watched-movies');
      const um = document.getElementById('unwatched-movies');

      if (tm) tm.textContent = totalMovies;
      if (wm) wm.textContent = watchedMovies;
      if (um) um.textContent = unwatchedMovies;
    }

    /* ==============================
     *  æœç´¢ç”µå½±ï¼ˆæ»šåŠ¨å¹¶é«˜äº®ï¼‰
     * ============================== */
    function searchMovies() {
      const query = prompt("è¯·è¾“å…¥è¦æœç´¢çš„ç”µå½±åï¼ˆå…³é”®è¯ï¼‰ï¼š");
      if (!query) return;

      document.querySelectorAll(".highlight").forEach(el => el.classList.remove("highlight"));

      const found = movies.find(m => m.title.includes(query));
      if (!found) {
        alert("æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç”µå½±ã€‚");
        return;
      }

      alert(`æ‰¾åˆ°ç”µå½±ï¼š${found.title} (${found.year})ï¼Œæ­£åœ¨å®šä½...`);

      if (!found.watched) {
        showSection('list-section');
        renderMovieList(); 
        const cards = document.querySelectorAll("#movie-list .movie-card");
        cards.forEach(card => {
          const h4 = card.querySelector("h4");
          if (h4 && h4.textContent.includes(found.title)) {
            card.classList.add("highlight");
            card.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        });
      } else {
        showSection('goal-section');
        renderCompletedList(); 
        const typeStr = found.type || "æœªçŸ¥ç±»å‹";
        const headers = document.querySelectorAll("#completed-collapsible .collapsible-header");
        const contents = document.querySelectorAll("#completed-collapsible .collapsible-content");
        for (let i = 0; i < headers.length; i++) {
          if (headers[i].textContent.includes(typeStr)) {
            if (!contents[i].classList.contains("show")) {
              contents[i].classList.add("show");
            }
            const cards = contents[i].querySelectorAll(".movie-card");
            cards.forEach(card => {
              const h4 = card.querySelector("h4");
              if (h4 && h4.textContent.includes(found.title)) {
                card.classList.add("highlight");
                card.scrollIntoView({ behavior: "smooth", block: "center" });
              }
            });
            break;
          }
        }
      }
    }

    /* ==============================
     *  æ‰‹åŠ¨æ·»åŠ ç”µå½± (å•è¡Œè¾“å…¥è§£æ)
     * ============================== */
    function addMovie() {
      const line = prompt("è¯·è¾“å…¥ç”µå½±ä¿¡æ¯ï¼ˆæ ¼å¼ï¼šæ ‡é¢˜/å¹´ä»½/å›½å®¶/è¯„åˆ†/ç±»å‹ï¼‰ï¼š");
      if (!line) return; 

      const parts = line.split('/');
      const title = parts[0]?.trim() || "";
      const year = parts[1]?.trim() || "æœªçŸ¥å¹´ä»½";
      const country = parts[2]?.trim() || "æœªçŸ¥å›½å®¶";
      const rating = parts[3]?.trim() || "æ— è¯„åˆ†";
      const type = parts[4]?.trim() || "æœªçŸ¥ç±»å‹";

      if (!title) {
        alert("ç”µå½±æ ‡é¢˜ä¸èƒ½ä¸ºç©ºï¼Œå·²å–æ¶ˆæ“ä½œã€‚");
        return;
      }

      const duplicate = movies.find(m => m.title === title && m.year === year);
      if (duplicate) {
        alert(`å·²å­˜åœ¨åŒååŒå¹´ç”µå½±ã€Š${title} (${year})ã€‹ï¼Œå·²è·³è¿‡ã€‚`);
        return;
      }

      const newMovie = {
        title,
        year,
        country,
        rating,
        type, 
        watched: false,
        review: ""
      };

      movies.push(newMovie);
      renderMovieList();
      updateStats();
      updatePointsDisplay();
      saveData();
      alert(`æˆåŠŸæ·»åŠ ï¼šã€Š${title}ã€‹ï¼`);
    }

    /* ==============================
     *  æ’åº/ç­›é€‰
     * ============================== */
     function openSortFilterModal() {
  const modal = document.getElementById("sort-filter-modal");
  modal.style.display = "block";
  populateFilterOptions(); // å¡«å……ç­›é€‰é€‰é¡¹
}

// å…³é—­æ’åº/ç­›é€‰æ¨¡æ€æ¡†
function closeSortFilterModal() {
  const modal = document.getElementById("sort-filter-modal");
  modal.style.display = "none";
}

// å¡«å……å›½å®¶ç­›é€‰é€‰é¡¹
function populateFilterOptions() {
  const countries = [...new Set(movies.map(m => m.country))]; // è·å–æ‰€æœ‰å›½å®¶
  const filterCountrySelect = document.getElementById("filter-country");
  filterCountrySelect.innerHTML = '<option value="">(ä¸é™)</option>'; // æ¸…ç©ºåŸæœ‰é€‰é¡¹
  countries.forEach(country => {
    const option = document.createElement("option");
    option.value = country;
    option.textContent = country;
    filterCountrySelect.appendChild(option);
  });
}

// åº”ç”¨æ’åºå’Œç­›é€‰
function applySortFilter() {
  const sortField = document.getElementById("sort-field").value;
  const sortOrder = document.getElementById("sort-order").value;
  const filterCountry = document.getElementById("filter-country").value;
  const filterRating = parseFloat(document.getElementById("filter-rating").value);

  // æ ¹æ®é€‰æ‹©çš„æ’åºå­—æ®µè¿›è¡Œæ’åº
  const sortedMovies = [...movies].sort((a, b) => {
    let compareValue = 0;

    // æŒ‰ç…§æ’åºå­—æ®µè¿›è¡Œæ¯”è¾ƒ
    if (sortField) {
      if (sortField === "year" || sortField === "rating") {
        compareValue = a[sortField] - b[sortField];
      } else if (sortField === "completedDate") {
        compareValue = new Date(a[sortField]) - new Date(b[sortField]);
      } else if (sortField === "title") {
        compareValue = a[sortField].localeCompare(b[sortField]);
      }
    }

    // æ ¹æ®é¡ºåºé€‰æ‹©å‡åºæˆ–é™åº
    if (sortOrder === "desc") {
      compareValue = -compareValue;
    }

    return compareValue;
  });

  // åº”ç”¨ç­›é€‰
  const filteredMovies = sortedMovies.filter(movie => {
    return (
      (filterCountry ? movie.country === filterCountry : true) &&
      (filterRating ? movie.rating >= filterRating : true)
    );
  });

  // æ›´æ–°ç”µå½±åˆ—è¡¨å±•ç¤º
  renderCompletedList(filteredMovies);
  closeSortFilterModal(); // å…³é—­æ¨¡æ€æ¡†
}

// æ¸²æŸ“å·²è§‚çœ‹åˆ—è¡¨
function renderCompletedList(moviesToRender = movies) {
  const container = document.getElementById("completed-collapsible");
  if (!container) return;
  container.innerHTML = '';

  const watchedMovies = moviesToRender.filter(m => m.watched);
  const types = {};
  watchedMovies.forEach(m => {
    const t = m.type || 'æœªçŸ¥ç±»å‹';
    if (!types[t]) types[t] = [];
    types[t].push(m);
  });

  // æŒ‰ç±»å‹é™åº
  Object.keys(types)
    .sort((a, b) => b.localeCompare(a))
    .forEach(typeStr => {
      const header = document.createElement("div");
      header.className = "collapsible-header";
      header.textContent = `${typeStr} (${types[typeStr].length}éƒ¨)`;
      header.onclick = () => {
        content.classList.toggle("show");
      };

      const content = document.createElement("div");
      content.className = "collapsible-content";
      const grid = document.createElement("div");
      grid.className = "movie-list-grid";

      types[typeStr].forEach(movie => {
        const div = document.createElement("div");
        div.className = "movie-card";
        div.dataset.movieId = movie.title; 

        let html = `
          <h4>${movie.title} (${movie.year})</h4>
          <p>${movie.country} | è¯„åˆ†ï¼š${movie.rating} | ç±»å‹ï¼š${movie.type}</p>
          <p>åˆè§ï¼š${movie.completedDate ? movie.completedDate : 'æœªè®¾å®š'}</p>
        `;
        if (movie.review) {
          html += `<div class="review-text">è§‚å½±æ„Ÿæƒ³ï¼š${movie.review}</div>`;
        }
        div.innerHTML = html;

        const editBtn = document.createElement("button");
        editBtn.textContent = "ç¼–è¾‘";
        editBtn.onclick = () => toggleEdit(div);
        div.appendChild(editBtn);

        grid.appendChild(div);
      });

      content.appendChild(grid);
      container.appendChild(header);
      container.appendChild(content);
    });
}

    /* ==============================
     *  åˆå§‹åŒ–
     * ============================== */
    function init() {
      renderMovieList();
      renderGoalList();
      renderCompletedList();
      updateStats();
      updatePointsDisplay();
    }

    init();
  </script>
</body>
</html>